# .github/workflows/full_ashare_pipeline.yml
name: A股全市场 K线 + 资金流 双数据源采集（2025最新生产版）

on:
  workflow_dispatch:

jobs:
  # ======================== 1. 准备任务分片 ========================
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install baostock
        run: pip install baostock pandas

      - name: Generate task slices
        run: python scripts/prepare_tasks.py

      - name: Upload task slices
        uses: actions/upload-artifact@v4
        with:
          name: task-slices
          path: task_slices/

  # ======================== 2. 并行下载 K线 ========================
  download-kline:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task_index: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]
      max-parallel: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download task slices
        uses: actions/download-artifact@v4
        with:
          name: task-slices
          path: tasks/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install baostock pandas pyarrow tqdm

      - name: Download K线
        env:
          TASK_INDEX: ${{ matrix.task_index }}
        run: python scripts/download_baostock_kdata.py

      - name: Upload K线分片
        uses: actions/upload-artifact@v4
        with:
          name: kline_part_${{ matrix.task_index }}
          path: data_kline/

  # ======================== 3. 合并 K线 ========================
  collect-kline:
    needs: download-kline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all kline parts
        uses: actions/download-artifact@v4
        with:
          path: all_kline

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install pandas pyarrow tqdm zstandard

      - name: Collect K线
        run: python scripts/collect_kdata.py

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: kdata-small-files
          path: kdata/
      - uses: actions/upload-artifact@v4
        with:
          name: full-kdata-parquet-optimized
          path: full_kdata.parquet
      - uses: actions/upload-artifact@v4
        with:
          name: data-quality-report-kline
          path: data_quality_report_kline.json

  # ======================== 4. 并行下载 资金流（关键修复！） ========================
  download-fundflow:
    needs: collect-kline
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task_index: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]
      max-parallel: 20
    steps:
      - name: Checkout repository                                 # 必须加这一行！
        uses: actions/checkout@v4

      - name: Download task slices
        uses: actions/download-artifact@v4
        with:
          name: task-slices
          path: tasks/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests pandas pyarrow tqdm

      - name: Download 资金流（新浪最新稳定版）
        env:
          TASK_INDEX: ${{ matrix.task_index }}
        run: python scripts/download_sina_fundflow.py

      - name: Upload 资金流分片
        uses: actions/upload-artifact@v4
        with:
          name: fundflow_part_${{ matrix.task_index }}
          path: data_fundflow/

  # ======================== 5. 合并 资金流 ========================
  collect-fundflow:
    needs: download-fundflow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all fundflow parts
        uses: actions/download-artifact@v4
        with:
          path: all_fundflow

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install pandas pyarrow tqdm zstandard psutil

      - name: Collect 资金流
        run: python scripts/collect_fundflow.py

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: fundflow-small-files
          path: fundflow_small/
      - uses: actions/upload-artifact@v4
        with:
          name: full-fundflow-parquet-optimized
          path: full_fundflow.parquet
      - uses: actions/upload-artifact@v4
        with:
          name: data-quality-report-fundflow
          path: data_quality_report_fundflow.json
